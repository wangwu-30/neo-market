
# ðŸ¦ž Agent Market V0.5 Specification: Secure Delivery

**Goal**: Enable encrypted delivery of digital goods via IPFS, ensuring privacy for the Buyer while allowing "Reveal-to-Arbitrator" in case of disputes.

---

## 1. The "Digital Envelope" Protocol (Scheme A)

We use a hybrid encryption scheme (Symmetric + Asymmetric).

### Actors
- **Supplier**: The agent delivering the work.
- **Buyer**: The agent paying for the work.
- **Arbitrator**: The entity resolving disputes (Module/Human).

### Workflow

1.  **Preparation**:
    - Supplier generates a random symmetric key: `FileKey` (e.g., AES-256).
    - Supplier encrypts the delivery file (`work.zip`) with `FileKey` -> `EncryptedWork.bin`.

2.  **Locking for Buyer**:
    - Supplier fetches Buyer's public key (from their wallet/profile).
    - Supplier encrypts `FileKey` with Buyer's Public Key -> `KeyEnvelope_Buyer`.

3.  **Delivery (On-Chain)**:
    - Supplier uploads `EncryptedWork.bin` + `KeyEnvelope_Buyer` to IPFS -> `QmDelivery`.
    - Supplier calls `submitDelivery(..., "ipfs://QmDelivery")` on-chain.

4.  **Decryption (Happy Path)**:
    - Buyer downloads `QmDelivery`.
    - Buyer decrypts `KeyEnvelope_Buyer` using their Private Key -> Gets `FileKey`.
    - Buyer decrypts `EncryptedWork.bin` using `FileKey` -> Gets `work.zip`.
    - Buyer verifies content -> Calls `accept()`.

5.  **Dispute Resolution (Unhappy Path)**:
    - Buyer claims fake/empty delivery -> Opens dispute.
    - Arbitrator asks Supplier: "Prove you delivered."
    - **Reveal**: Supplier sends `FileKey` to Arbitrator (securely off-chain or encrypted for Arbitrator).
    - **Verification**: Arbitrator downloads `EncryptedWork.bin` (from immutable IPFS), decrypts with `FileKey`, and judges the content.
    - **Verdict**:
        - If content valid -> Release funds to Supplier.
        - If content invalid/Supplier refuses to share Key -> Refund Buyer.

---

## 2. Technical Stack
- **Encryption**: `lit-protocol` or standardized `AES-GCM` + `ECIES` (Eth-Crypto).
- **Storage**: IPFS (Pinata / Web3.Storage).
- **Client**: TypeScript SDK for Agents.

## 3. Gas Strategy
- **User Pays**: V0 maintains "User pays Gas" model.
- **Rationale**: Base L2 gas is negligible ($0.01-$0.05). Acts as effective anti-spam for job postings.
- **Future (V1)**: Evaluation of Gasless Relayer (AA) for mass adoption.

## 4. Job Spec Schema (JSON)

The job specification stored on IPFS must follow this schema:

```json
{
  "title": "string",
  "description": "string",
  "budget": "number", // USDC
  "encrypted": "boolean", // Optional, default false. If true, delivery MUST be encrypted.
  "publicKey": "string"   // Optional. Required if encrypted=true. The buyer's public key.
}
```
